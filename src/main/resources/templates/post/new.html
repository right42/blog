<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default.html}">

<head>
    <title th:text="Right blog"></title>
</head>

<th:block layout:fragment="header">
    <th:block th:replace="~{fragments/header :: header}"></th:block>
</th:block>

<th:block layout:fragment="content">
    <div class="container">
        <form action="/posts" id="form" method="post">
            <div class="form-group">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="text" id="title" name="title" class="form-control" placeholder="Title">
            </div>

            <div class="form-group">
                <textarea id="content" name="content"></textarea>
            </div>

            <div id="tagBox" class="form-group">
                <div id="selectedTags" class="form-group">

                </div>

                <div class="input-group mb-3">
                    <input id="tagSearch" name="tagSearch" type="text" class="form-control" placeholder="Tag name..." aria-label="Tag name.." aria-describedby="tagSave">
                    <div class="input-group-append">
                        <button id="saveTag" class="btn btn-outline-secondary" type="button" >Tag Add</button>
                    </div>
                </div>
                <div id="tags" class="form-group"></div>
                <div id="alert" class="alert alert-danger fade" role="alert"></div>
            </div>

            <div class="form-group">
                <button type="button" id="save" class="btn btn-outline-primary">Save</button>
            </div>
        </form>
    </div>
    <hr>
</th:block>

<th:block layout:fragment="myScript">
    <script src="https://cdn.ckeditor.com/ckeditor5/16.0.0/classic/ckeditor.js"></script>
    <script src="/js/ckeditor-custom-adapter.js"></script>
    <script src="/js/tag.js"></script>
    <script>
        var timer;

        window.addEventListener('load', function(){

            ClassicEditor
                .create( document.querySelector('#content'), {
                    'removePlugins' : ['Italic', 'MediaEmbed'],
                    extraPlugins: [ MyCustomUploadAdapterPlugin ]
                })
                .catch( error => {
                    console.error( error );
                } );

            document.querySelector('#tagSearch').addEventListener('input', function(){
                if ( timer ) {
                    clearTimeout(timer);
                }

                let value = this.value;
                if ( value === '') {
                    clearChild('#tags');
                    return;
                }
                
                timer = setTimeout(function() {
                    axios.get('/api/v1/tags?q=' + value)
                        .then(({data : res}) => {
                            $tag.render(res);
                        })
                        .catch((err) => {
                            console.error(err);
                        });
                }, 400);
            });

            document.querySelector('#save').onclick = function(){
                $tag._tagIds.forEach((e) => {
                    let tagId = document.createElement('input');
                    tagId.type = 'hidden';
                    tagId.name = 'tagIds';
                    tagId.value = e;
                    this.form.appendChild(tagId);
                });

                this.form.submit();
            }

            document.querySelector('#saveTag').addEventListener('click', function(){
                let name = document.querySelector('#tagSearch').value;
                if ( name === '') {
                    return;
                }

                axios.post('/api/v1/tags', {name}, {
                    headers : {
                        'X-CSRF-TOKEN' : document.querySelector('input[name=_csrf]').value,
                        'contentType' : 'application/json'
                    }
                })
                .then((res) => {
                    document.querySelector('.alert').classList.add('fade');
                    $tag.addTag(name, res.data.id);
                })
                .catch((err) => {
                    let errorAlert = document.querySelector('.alert');
                    errorAlert.textContent = err.response.data.message;
                    errorAlert.classList.remove('fade');
                });
            });
        });

        function clearChild(selector){
            let tag = document.querySelector(selector);
            if ( tag.hasChildNodes()) {
                tag.childNodes.forEach((node) => {
                    node.remove();
                });
            }
        }
    </script>
</th:block>